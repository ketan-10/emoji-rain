name: Deploy Server AWS

on: 
  push:
    branches: 
      - server

jobs:
  deploy-aws:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [14.x]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v2
      with:
        node-version: ${{ matrix.node-version }}

    # https://stackoverflow.com/questions/58139175/running-actions-in-another-directory
    
    - name: Lambda - Install dependencies
      working-directory: ./lambdas/emoji-rain-handler
      run: npm i

    - name: Lambda - Test
      working-directory: ./lambdas/emoji-rain-handler
      run: npm run test

    - name: upload code coverage
        uses: codecov/codecov-action@v2
        with:
          files: ./lambdas/emoji-rain-handler/coverage/clover.xml
          fail_ci_if_error: true # optional (default = false)

    - name: Lambda - Build using NCC
      working-directory: ./lambdas/emoji-rain-handler
      run: npx ncc build index.ts -o dist/ncc

    - name: Lambda - Create ZIP
      working-directory: ./lambdas/emoji-rain-handler
      run: zip -j dist/deploy.zip ./dist/ncc/*

    # CDK 

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{secrets.AWS_ACCESS_KEY_ID}}
        aws-secret-access-key: ${{secrets.AWS_SECRET_ACCESS_KEY}}
        aws-region: us-east-2

    - name: Install AWS CDK
      run: npm install -g aws-cdk

    - name: CDK - Install dependencies
      run: npm i

    - name: CDK - Synth
      run: cdk synth

    - name: CDK - Test
      run: npm run test

    - name: CDK - Diff
      run: cdk diff
    
    - name: CDK - Bootstrap
      run: cdk bootstrap

    - run: mkdir -p artifact

    - name: CDK - Deploy
      run: |
        cdk deploy --outputs-file artifact/cdk-outputs.json --require-approval never
        cat artifact/cdk-outputs.json

    - name: Upload cdk-outputs artifact
      uses: actions/upload-artifact@v2
      with:
        name: my-artifact
        path: artifact/cdk-outputs.json


  upload-url-frontend:
    needs: deploy-aws
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Master
      uses: actions/checkout@v2
      with:
        ref: 'master'
        token: ${{ secrets.MY_PERSONAL_TOKEN_PUBLIC }}

    - name: Download cdk-outputs
      uses: actions/download-artifact@v2
      with:
        name: my-artifact
        path: artifact/cdk-outputs.json
    
    - name: list files
      run: ls

# https://docs.github.com/en/actions/reference/authentication-in-a-workflow#using-the-github_token-in-a-workflow
# git commit -m "[BOT] [CDK-OUTPUT]" --allow-empty 
        
    - name: Push to master
      run: |
        git config --global user.email ${{secrets.MY_EMAIL}}
        git config --global user.name ${{secrets.MY_USERNAME}}
        git remote set-url origin https://${{secrets.MY_PERSONAL_TOKEN_PUBLIC}}@github.com/${{github.repository}}
        git status
        git add artifact/cdk-outputs.json
        (git commit -m "[BOT] [CDK-OUTPUT]" && git push) || true